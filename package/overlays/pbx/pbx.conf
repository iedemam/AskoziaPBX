# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: package/.../pbx/pbx.conf
# Copyright (C) 2009 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---

pbx_main() {

	cd $base/package/overlays/pbx/rootfs
	#find usr/www/ -type f -name "*.php" -exec php -l {} \; -print | grep Parse
	#find usr/www/ -type f -name "*.inc" -exec php -l {} \; -print | grep Parse
	#find etc/inc/ -type f -name "*.inc" -exec php -l {} \; -print | grep Parse
	#sleep 5

	cd usr/www/locale
	# backup the skeleton localization file
	cp skeleton.po skeleton.po.prev
	# merge in any possible string changes
	xgettext -o skeleton.po --no-wrap --no-location --language=PHP --from-code=utf-8 ../../../etc/inc/*.inc ../../../usr/www/*.inc ../../../usr/www/*.php
	# if there are any changes beyond the date line, remerge the rest of the locale files
	if [[ `diff -u skeleton.po.prev skeleton.po | cut -c 1 | grep + | wc -l` -gt 2 ]] ||
		[[ `diff -u skeleton.po.prev skeleton.po | cut -c 1 | grep - | wc -l` -gt 2 ]] ||
		[[ `find ./ -type f -name messages.mo -print | wc -l` -eq 0 ]] ; then
		rm -f locale_status.txt
		for file in `find ./ -type f -name messages.po -print`
		do
			dir=`dirname $file`
			lang=`echo $dir | cut -c3-7`
			msgmerge $file skeleton.po -o $file
			msgfmt -o $dir/messages.mo $file
			$base/scripts/pocount.sh $file $lang >> locale_status.txt
		done
	# otherwise, revert that update since it is only the date line
	else
		cp skeleton.po.prev skeleton.po
	fi
	# cleanup
	rm skeleton.po.prev

	# copy the updated overlay files into the build
	cp -Rfv $base/package/overlays/pbx/rootfs/* $root/
}

mainfunction="pbx_main"
