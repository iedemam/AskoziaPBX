# --- T2-COPYRIGHT-NOTE-BEGIN ---
# This copyright note is auto-generated by ./scripts/Create-CopyPatch.
# 
# T2 SDE: target/share/firmware/build.sh
# Copyright (C) 2004 - 2008 The T2 SDE Project
# 
# More information can be found in the files COPYING and README.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 of the License. A copy of the
# GNU General Public License can be found in the file COPYING.
# --- T2-COPYRIGHT-NOTE-END ---
#
#Description: initramfs

. $base/misc/target/functions.in

set -e

# set initramfs preparation directory
imagelocation="$build_toolchain/initramfs"

echo "Preparing initramfs image from build result ..."

rm -rf $imagelocation{,.cpio,.igz}
mkdir -p $imagelocation ; cd $imagelocation

find $build_root -printf "%P\n" | sed '

# stuff we never need

/^TOOLCHAIN/			d;
/^var\/adm/				d;

/\/include/				d;
/\/src/					d;
/\.a$/					d;
/\.o$/					d;
/\.old$/				d;

/\/games/				d;
/\/local/				d;
/^boot/					d;

/\/man/					d;
/\/doc/					d;

# /etc noise
/^etc\/asterisk/		d;
/^etc\/conf/			d;
/^etc\/cron.d/			d;
/^etc\/cron.daily/		d;
/^etc\/hotplug/			d;
/^etc\/hotplug.d/		d;
/^etc\/init.d/			d;
/^etc\/opt/				d;
/^etc\/postinstall.d/	d;
/^etc\/profile.d/		d;
/^etc\/rc.d/			d;
/^etc\/skel/			d;
/^etc\/stone.d/			d;

/^opt/					d;

/^\/man\//				d;

# /usr/lib
/usr\/lib\/build/		d;
/usr\/lib\/gettext/		d;
/usr\/lib\/grub/		d;
/usr\/lib\/perl5/		d;
/usr\/lib\/pkgconfig/	d;

# /usr/share
/usr\/share\/aclocal/	d;
/usr\/share\/autoconf/	d;
/usr\/share\/automake/	d;
/usr\/share\/bison/		d;
/usr\/share\/dict/		d;
/usr\/share\/gettext/	d;
/usr\/share\/info/		d;
/usr\/share\/libtool/	d;
/usr\/share\/misc/		d;

# terminfo
/terminfo\/a\/ansi$/	{ p; d; }
/terminfo\/l\/linux$/	{ p; d; }
/terminfo\/x\/xterm$/	{ p; d; }
/terminfo\/n\/nxterm$/	{ p; d; }
/terminfo\/x\/xterm-color$/	{ p; d; }
/terminfo\/x\/xterm-8bit$/	{ p; d; }
/terminfo\/x\/screen$/	{ p; d; }
/terminfo\/v\/vt100$/	{ p; d; }
/terminfo\/v\/vt200$/	{ p; d; }
/terminfo\/v\/vt220$/	{ p; d; }
/terminfo/	d;

# stuff too big for a ramfs
/^asterisk/	d;

' > tar.input

copy_with_list_from_file $build_root . $PWD/tar.input
rm tar.input

echo "Preparing initramfs image from target defined files ..."
copy_from_source $base/target/$target/rootfs .
copy_from_source $base/target/share/initramfs/rootfs .

echo "Stamping build ..."
echo linux-pre-alpha > etc/version
echo `date` > etc/version.buildtime
#_exec("echo " . time() . " > etc/version.buildtime.unix");
echo generic-pc > etc/platform

echo "Creating links for identical files ..."
link_identical_files

echo "Setting permissions ..."
chmod 755 etc/rc*
chmod 644 etc/pubkey.pem
chmod 644 etc/inc/*
chmod 644 usr/www/*
chmod 755 usr/www/*.php
chmod 755 usr/www/*.cgi
chmod 755 usr/share/udhcpc/default.script

echo "Cleaning away stray files ..."
find ./ -type f -name "._*" -print -delete

echo "Creating initramfs image ..."
find . | cpio -H newc -o > ../initramfs.cpio

echo "Compressing initramfs image ..."
cd ..
cat initramfs.cpio | gzip > initramfs.igz

rm initramfs.cpio
du -sh $imagelocation{,.igz}

echo "The image is located at $imagelocation.igz."
